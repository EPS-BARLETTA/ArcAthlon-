<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Arcathlon</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f4f7fb; --card:#ffffff; --ink:#111827; --muted:#6b7280; --primary:#0a58ff;
    --green:#22c55e; --amber:#f59e0b; --red:#ef4444; --violet:#7c3aed; --slate:#334155;
    --radius:16px; --ring:0 8px 40px rgba(2,6,23,.08);
    --panel1:#e8f1ff; --panel2:#e9fbe8; --band:#eef2f7;
  }
  *{box-sizing:border-box}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font:16px/1.4 Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    min-height:100vh; display:flex; flex-direction:column; padding-bottom:56px;
  }
  footer{
    position:fixed; left:0; right:0; bottom:0;
    border-top:1px solid #e5e7eb; color:var(--muted);
    text-align:center; padding:10px 0; background:#fff;
  }
  .shell{max-width:980px;margin:0 auto;padding:16px}
  h1{font-size:clamp(22px,3.4vw,32px);margin:8px 0 4px;font-weight:800;text-align:center}
  h2{font-size:clamp(20px,2.8vw,28px);margin:8px 0 12px;font-weight:800;text-align:center}
  h3{margin:0 0 10px;font-size:18px;text-align:center}
  p{margin:0 0 8px;text-align:center}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--ring);padding:16px;margin:12px 0}
  .btns{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  button{border:0;border-radius:16px;padding:14px 18px;font-weight:800;cursor:pointer;font-size:18px}
  .b-primary{background:var(--primary);color:#fff}
  .b-green{background:var(--green);color:#fff}
  .b-amber{background:var(--amber);color:#111}
  .b-red{background:var(--red);color:#fff}
  .b-violet{background:var(--violet);color:#fff}
  .b-slate{background:var(--slate);color:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .panel{border-radius:16px;padding:16px}
  .panel1{background:var(--panel1)}
  .panel2{background:var(--panel2)}
  .band{background:var(--band);border-radius:12px;padding:10px 12px;margin-top:16px;font-weight:700}
  label{display:block;font-weight:800;margin:10px 0 6px}
  input,select{width:100%;padding:14px 16px;border:2px solid #e5e7eb;border-radius:14px;background:#fff;font:inherit}
  input[type=number]{appearance:textfield}
  select{background:#fff}
  .muted{color:var(--muted)}
  .hidden{display:none!important}
  .center{text-align:center}
  .big{font-size:40px;font-weight:900}
  .xl{font-size:60px;font-weight:900}
  .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:#eef2f7}
  table{width:100%;border-collapse:collapse}
  th,td{padding:12px;border-bottom:1px solid #e5e7eb;text-align:center;font-size:16px}
  .lock *{pointer-events:none; opacity:.7}
  .shot-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:8px}

  /* Accueil */
  #view-cover{min-height:calc(100vh - 56px); display:flex; align-items:center; justify-content:center;}
  .cover-stack{display:flex; flex-direction:column; gap:16px; align-items:center;}
  .substack{display:flex; gap:12px; flex-wrap:wrap; justify-content:center;}
  .tagline{color:var(--muted)}

  /* Modales */
  .modal{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:50;
    background:linear-gradient(180deg,rgba(2,6,23,.55),rgba(2,6,23,.35));}
  .modal-card{background:#fff; border-radius:20px; max-width:900px; width:92%; overflow:hidden; box-shadow:0 12px 48px rgba(2,6,23,.25)}
  .modal-head{display:flex; align-items:center; gap:12px; padding:16px 18px; color:#fff; font-weight:800}
  .modal-head.help{background:linear-gradient(90deg,#0a58ff,#7c3aed)}
  .modal-head.safe{background:linear-gradient(90deg,#22c55e,#0ea5e9)}
  .modal-head.indice{background:linear-gradient(90deg,#111827,#0a58ff)}
  .modal-body{padding:18px}
  .modal-body h4{margin:12px 0 6px}
  .help-list{margin:8px 0 12px; line-height:1.55}
  .help-list li{margin:6px 0}

  /* Overlays fin & bilan */
  #endOverlay{position:fixed; inset:0; display:none; z-index:60; align-items:center; justify-content:center; background:rgba(2,6,23,.55);}
  #endOverlay.show{display:flex;}
  #summaryOverlay{position:fixed; inset:0; display:none; z-index:60; align-items:center; justify-content:center; background:rgba(2,6,23,.55);} 
  #summaryOverlay.show{display:flex;}
  .end-card{background:#fff; border-radius:20px; padding:20px; width:min(720px,92%); box-shadow:0 12px 48px rgba(2,6,23,.25); text-align:center;}
  .end-card h3{margin-top:0}
  .end-note{color:var(--muted); margin-top:8px}

  /* Encadr√©s stats tir + pastilles */
  .statsBox{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; border:2px solid #e5e7eb; border-radius:14px; padding:10px; background:#fff;}
  .stat{display:flex; gap:8px; align-items:center; font-weight:800; padding:8px 12px; border-radius:12px; border:1px solid transparent}
  .stat.allowed{background:rgba(10,88,255,.10); color:#0a58ff; border-color:rgba(10,88,255,.25)}
  .stat.tired{background:rgba(124,58,237,.10); color:#7c3aed; border-color:rgba(124,58,237,.25)}
  .stat.remain{background:rgba(34,197,94,.12); color:#15803d; border-color:rgba(34,197,94,.25)}

  .summaryBox{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center; border:2px dashed #e5e7eb; border-radius:12px; padding:10px; background:#fff; margin-top:10px}
  .sumchip{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; font-weight:800}
  .sumchip.indice{background:rgba(10,88,255,.10); color:#0a58ff}
  .sumchip.chip10{background:rgba(34,197,94,.12); color:#14532d}
  .sumchip.chip9{background:rgba(16,185,129,.12); color:#065f46}
  .sumchip.chip8{background:rgba(59,130,246,.12); color:#1e3a8a}
  .sumchip.chip7{background:rgba(245,158,11,.15); color:#7c2d12}
  .sumchip.chip6{background:rgba(244,63,94,.10); color:#9f1239}
  .sumchip.chip0{background:rgba(239,68,68,.12); color:#7f1d1d}

  /* Conseils observateur (toasts) */
  .coachbox{margin-top:12px}
  .coachtip{
    background:#fff; border-radius:12px; padding:10px 12px; margin-top:8px;
    display:flex; gap:10px; align-items:flex-start; box-shadow:var(--ring);
    border-left:4px solid #0a58ff; animation:fadein .22s ease-out;
  }
  .coachtip.good{border-left-color:#22c55e}
  .coachtip.ok{border-left-color:#0a58ff}
  .coachtip.warn{border-left-color:#f59e0b}
  .coachtip.alert{border-left-color:#ef4444}
  @keyframes fadein { from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none} }
</style>
</head>
<body>
  <!-- Accueil -->
  <main class="shell" id="view-cover">
    <section class="card center" style="padding:28px 20px">
      <div class="cover-stack">
        <div>
          <h1>Arcathlon</h1>
          <p class="tagline">Application EPS compatible ScanProf</p>
        </div>
        <div class="btns" style="margin-top:12px">
          <button class="b-primary" id="btnStart">‚ñ∂Ô∏è D√©marrer</button>
        </div>
        <div class="substack">
          <button class="b-slate" id="btnHelp">‚ÑπÔ∏è Aide</button>
          <button class="b-amber" id="btnSafety">üõü Fiche s√©curit√©</button>
          <button class="b-slate" id="btnIndiceArc">üéØ Indice arc</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Modale Aide -->
  <div class="modal hidden" id="modalHelp">
    <div class="modal-card">
      <div class="modal-head help"><span>‚ÑπÔ∏è</span><span>Mode d‚Äôemploi ‚Äî Arcathlon</span></div>
      <div class="modal-body">
        <ol class="help-list">
          <li>Saisir pour chaque coureur : <strong>Pr√©nom</strong>, <strong>Nom</strong>, <strong>Classe</strong>, <strong>Sexe</strong>.</li>
          <li>D√©finir la <strong>Dur√©e (min)</strong>, la <strong>Longueur du tour (m)</strong> et la <strong>r√®gle fl√®ches</strong> (ex. 3 tours ‚Üí 3 fl√®ches).</li>
          <li>En course : <strong>Start/Pause</strong> le chrono ; <strong>+1 / ‚àí1</strong> pour les tours.</li>
          <li>Le tir est <strong>d√©bloqu√© par blocs</strong> (selon votre r√®gle). Boutons scores : <b>0, 6, 7, 8, 9, 10</b>.</li>
          <li>Fin du temps : compl√©ter la <strong>fraction de tour</strong> (0 / ¬º / ¬Ω / ¬æ), valider, puis g√©n√©rer <strong>QR</strong> et <strong>CSV</strong>.</li>
        </ol>
        <div class="btns"><button class="b-slate" data-close>Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Modale Fiche s√©curit√© -->
  <div class="modal hidden" id="modalSafety">
    <div class="modal-card">
      <div class="modal-head safe"><span>üõü</span><span>Fiche s√©curit√© ‚Äî Arcathlon</span></div>
      <div class="modal-body">
        <h4>Avant l‚Äôactivit√©</h4>
        <ul class="help-list">
          <li>V√©rifier la zone de course : trac√© d√©gag√©, surface adh√©rente, absence d‚Äôobstacles dangereux.</li>
          <li>Installer un <strong>pas de tir mat√©rialis√©</strong> (ligne de tir + zone d‚Äôattente en retrait).</li>
          <li>Contr√¥ler arcs/fl√®ches (√©tat des branches, corde, empennage, pointes), EPI si n√©cessaires.</li>
        </ul>
        <h4>R√®gles au pas de tir</h4>
        <ul class="help-list">
          <li>Arc toujours dirig√© vers les cibles. <strong>Ne jamais</strong> bander l‚Äôarc en dehors du pas de tir.</li>
          <li>Tirer <strong>uniquement</strong> sur signal/autorisation ; <strong>personne</strong> devant la ligne de tir.</li>
          <li>On cesse le tir imm√©diatement √† tout signal d‚Äôarr√™t ; poser les arcs, reculer d‚Äôun pas.</li>
        </ul>
        <h4>R√©cup√©ration des fl√®ches</h4>
        <ul class="help-list">
          <li>R√©cup√©ration <strong>sur signal</strong> uniquement ; marche, pas de course devant les cibles.</li>
          <li>Une main contre la cible pour la stabilit√©, l‚Äôautre retire la fl√®che dans l‚Äôaxe ; v√©rifier qu‚Äôaucune personne n‚Äôest derri√®re.</li>
        </ul>
        <h4>Circulation course ‚Üî tir</h4>
        <ul class="help-list">
          <li>Flux s√©par√©s (sens de circulation). On <strong>attend son tour</strong> dans la zone d‚Äôattente.</li>
          <li>Respect mutuel : pas de d√©passement agressif, vigilance aux croisements.</li>
        </ul>
        <div class="btns"><button class="b-slate" data-close>Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Modale Indice arc -->
  <div class="modal hidden" id="modalIndice">
    <div class="modal-card">
      <div class="modal-head indice"><span>üéØ</span><span>Indice arc ‚Äî Explications</span></div>
      <div class="modal-body">
        <p><strong>But :</strong> mesurer la pr√©cision au tir, de 0 √† 100%.</p>
        <p><strong>Scores possibles par fl√®che :</strong> 0, 6, 7, 8, 9, 10.</p>
        <p><strong>Calcul :</strong> moyenne sur 10, convertie sur 100.</p>
        <ul class="help-list">
          <li>Total fl√®ches T = nb0 + nb6 + nb7 + nb8 + nb9 + nb10</li>
          <li>Total points P = 0√ónb0 + 6√ónb6 + 7√ónb7 + 8√ónb8 + 9√ónb9 + 10√ónb10</li>
          <li><b>Indice arc (%) = (P / T) √∑ 10 √ó 100</b> (arrondi √† 2 d√©cimales)</li>
        </ul>
        <p class="muted">Exemple : 4√ó10, 4√ó9, 2√ó8 ‚áí P=92 pour 10 fl√®ches ‚áí 92%.</p>
        <div class="btns"><button class="b-slate" data-close>Fermer</button></div>
      </div>
    </div>
  </div>

  <!-- Saisie 2 coureurs -->
  <main class="shell hidden" id="view-duo">
    <section class="card">
      <h2>Saisie des informations</h2>
      <p class="muted">Identit√© des deux coureurs + param√®tres communs.</p>
      <div class="row">
        <div class="panel panel1">
          <h3>COUREUR 1</h3>
          <label>Pr√©nom</label><input id="p1_prenom" maxlength="60" autocomplete="off"/>
          <label>Nom</label><input id="p1_nom" maxlength="60" autocomplete="off"/>
          <label>Classe</label><input id="p1_classe" maxlength="60" autocomplete="off"/>
          <label>Sexe</label>
          <select id="p1_sexe"><option value="">‚Äî</option><option>F</option><option>M</option></select>
        </div>
        <div class="panel panel2">
          <h3>COUREUR 2</h3>
          <label>Pr√©nom</label><input id="p2_prenom" maxlength="60" autocomplete="off"/>
          <label>Nom</label><input id="p2_nom" maxlength="60" autocomplete="off"/>
          <label>Classe</label><input id="p2_classe" maxlength="60" autocomplete="off"/>
          <label>Sexe</label>
          <select id="p2_sexe"><option value="">‚Äî</option><option>F</option><option>M</option></select>
        </div>
      </div>

      <div class="band">Param√®tres de course</div>
      <div class="row">
        <div>
          <label>Dur√©e (minutes)</label>
          <input id="duree_min" type="number" inputmode="numeric" min="1" step="1" placeholder="ex. 20"/>
        </div>
        <div>
          <label>Longueur d'un tour (m)</label>
          <input id="tour_m" type="number" inputmode="numeric" min="10" step="1" placeholder="ex. 200"/>
        </div>
      </div>

      <div class="band">R√®gle fl√®ches (blocs)</div>
      <div class="row">
        <div>
          <label>Tours par bloc</label>
          <input id="tours_bloc" type="number" inputmode="numeric" min="1" step="1" value="3"/>
        </div>
        <div>
          <label>Fl√®ches par bloc</label>
          <input id="fleches_bloc" type="number" inputmode="numeric" min="1" step="1" value="3"/>
        </div>
      </div>
      <div class="btns" style="margin-top:8px">
        <button class="b-slate" id="preset33">3 tours ‚Üí 3 fl√®ches</button>
        <button class="b-slate" id="preset11">1 tour ‚Üí 1 fl√®che</button>
        <button class="b-slate" id="preset13">1 tour ‚Üí 3 fl√®ches</button>
      </div>

      <div class="band">Observation & conseils</div>
      <label style="display:flex; align-items:center; gap:8px; justify-content:center">
        <input id="obs_on" type="checkbox" checked>
        <span>Activer les conseils (apr√®s chaque tir et fin de vol√©e)</span>
      </label>
      <div style="margin-top:8px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap">
        <label>Progression distance
          <select id="obs_mode">
            <option value="none">Sans recommandation</option>
            <option value="remediation" selected>Rem√©diation (vol√©e faible ‚áí avancer)</option>
            <option value="challenge">Challenge (vol√©e forte ‚áí reculer)</option>
          </select>
        </label>
      </div>

      <div class="btns" style="margin-top:18px">
        <button class="b-primary" id="goCourse" disabled>Acc√©der √† la course</button>
        <button class="b-slate" id="goHome">üè† Accueil</button>
      </div>
    </section>
  </main>

  <!-- Course + Tir -->
  <main class="shell hidden" id="view-course">
    <section class="card center" id="courseCard">
      <div class="btns" style="margin-bottom:8px">
        <button class="b-slate" id="backToDuo">‚¨Ö Retour saisie</button>
        <span class="pill" id="courseMeta">‚Äî</span>
      </div>
      <h2 id="runnerTitle">Coureur ‚Äî </h2>
      <div class="btns" style="margin-bottom:6px">
        <button class="b-green" id="pickP1">üëü Coureur 1</button>
        <button class="b-green" id="pickP2">üëü Coureur 2</button>
      </div>

      <!-- Chrono -->
      <div class="card" style="max-width:720px;margin:0 auto 12px">
        <div class="xl" id="clock">00:00.0</div>
        <div class="btns" style="margin-top:8px">
          <button class="b-primary" id="btnStartCourse">‚ñ∂Ô∏è Start</button>
          <button class="b-amber" id="btnPause" disabled>‚è∏Ô∏è Pause</button>
          <button class="b-red" id="btnReset" disabled>‚Ü∫ R√©init.</button>
        </div>
        <p class="muted">Dur√©e cible : <strong id="target"></strong> min</p>
      </div>

      <!-- Tours + Tir -->
      <div class="row" style="max-width:720px;margin:0 auto">
        <div class="card">
          <h3>üèÅ Tours</h3>
          <div class="big" id="laps">0</div>
          <p class="muted">1 tour = <span id="lapMeters">‚Äî</span> m</p>
          <p class="muted"><strong>Distance provisoire :</strong> <span id="liveDistance">0</span> m</p>
          <div class="btns">
            <button class="b-green" id="lapPlus">+1 tour</button>
            <button class="b-slate" id="lapMinus">‚àí1</button>
          </div>
        </div>
        <div class="card">
          <h3>üèπ Tir √† l‚Äôarc (0, 6, 7, 8, 9, 10)</h3>

          <!-- Encadr√© color√© fl√®ches -->
          <div class="statsBox" id="shotsEncadre">
            <div class="stat allowed">Autoris√©es : <span id="allowed">0</span></div>
            <div class="stat tired">Tir√©es : <span id="shotCount">0</span></div>
            <div class="stat remain">Restantes : <span id="remain">0</span></div>
          </div>

          <!-- Boutons de saisie -->
          <div class="shot-grid" id="scoreButtons" style="margin-top:10px">
            <button class="b-slate" data-score="0">0</button>
            <button class="b-slate" data-score="6">6</button>
            <button class="b-slate" data-score="7">7</button>
            <button class="b-slate" data-score="8">8</button>
            <button class="b-slate" data-score="9">9</button>
            <button class="b-slate" data-score="10">10</button>
          </div>

          <!-- Conseils observateur -->
          <div id="coachBox" class="coachbox hidden"></div>

          <!-- R√©sum√© imm√©diat -->
          <div class="summaryBox" id="shootSummary">
            <span class="sumchip chip10">Nb 10 : <b id="c10">0</b></span>
            <span class="sumchip chip9">Nb 9 : <b id="c9">0</b></span>
            <span class="sumchip chip8">Nb 8 : <b id="c8">0</b></span>
            <span class="sumchip chip7">Nb 7 : <b id="c7">0</b></span>
            <span class="sumchip chip6">Nb 6 : <b id="c6">0</b></span>
            <span class="sumchip chip0">Nb 0 : <b id="c0">0</b></span>
            <span class="sumchip indice">Indice arc : <b id="indiceArc">0</b>%</span>
          </div>

          <!-- D√©tails tirs -->
          <div style="overflow:auto;margin-top:8px">
            <table>
              <thead><tr><th>#</th><th>Score</th><th>Action</th></tr></thead>
              <tbody id="shotsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Panneau fin + overlay -->
      <div class="card hidden" id="endCard" style="max-width:720px;margin:12px auto 0">
        <h3>‚è±Ô∏è Temps √©coul√© ‚Äî compl√©ter la fraction de tour</h3>
        <div class="btns">
          <button class="b-slate" data-frac="0">+ 0</button>
          <button class="b-slate" data-frac="0.25">+ 1/4</button>
          <button class="b-slate" data-frac="0.5">+ 1/2</button>
          <button class="b-slate" data-frac="0.75">+ 3/4</button>
          <button class="b-green" id="finishRunner">‚úÖ Terminer la course</button>
        </div>
        <p class="muted" id="distanceOut">Distance: ‚Äî m</p>
      </div>

      <div class="btns hidden" id="toSummaryWrap" style="margin-top:12px">
        <button class="b-primary" id="goSummary">üìä Aller au bilan</button>
      </div>
    </section>
  </main>

  <!-- Overlay fin -->
  <div id="endOverlay" aria-modal="true" role="dialog">
    <div class="end-card">
      <h3>‚è≥ Temps √©coul√©</h3>
      <p class="muted">Compl√©ter la fraction de tour si besoin, puis valider la course.</p>
      <div class="btns" style="margin:10px 0 4px">
        <button class="b-slate" data-frac-overlay="0">+ 0</button>
        <button class="b-slate" data-frac-overlay="0.25">+ 1/4</button>
        <button class="b-slate" data-frac-overlay="0.5">+ 1/2</button>
        <button class="b-slate" data-frac-overlay="0.75">+ 3/4</button>
      </div>
      <p class="end-note" id="distanceOutOverlay">Distance: ‚Äî m</p>
      <div class="btns" style="margin-top:8px">
        <button class="b-green" id="finishRunnerOverlay">‚úÖ Terminer la course</button>
      </div>
    </div>
  </div>

  <!-- Overlay bilan pr√™t -->
  <div id="summaryOverlay" aria-modal="true" role="dialog">
    <div class="end-card">
      <h3>üìä Bilan pr√™t</h3>
      <p class="muted">Les deux coureurs sont termin√©s. G√©n√©rer le QR/CSV ?</p>
      <div class="btns" style="margin-top:8px">
        <button class="b-primary" id="overlayGoSummary">üìä Acc√©der au bilan</button>
        <button class="b-slate" id="overlayCloseSummary">‚¨Ö Retour</button>
      </div>
    </div>
  </div>

  <!-- Bilan / QR -->
  <main class="shell hidden" id="view-summary">
    <section class="card center">
      <h2>Bilan ‚Äî QR compatible ScanProf</h2>
      <div id="qr" class="card" style="display:inline-block"></div>

      <div class="card prof-tools">
        <div class="prof-row" style="display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap">
          <input id="profCode" type="password" inputmode="numeric" placeholder="Entrer code Prof"/>
          <button class="b-slate" id="activateProf">üîì Activer mode Prof</button>
          <button class="b-amber" id="deactivateProf" disabled>üîí D√©sactiver</button>
          <button class="b-violet" id="applyEdits" disabled>üíæ Mettre √† jour QR/CSV</button>
          <button class="b-violet" id="exportCsv">‚¨áÔ∏è Export CSV</button>
        </div>
        <p class="muted" id="profHint" style="margin-top:8px"></p>
      </div>

      <div id="resume"></div>

      <div class="btns" style="margin-top:8px">
        <button class="b-slate" id="backToCourse">‚¨Ö Retour course</button>
        <button class="b-green" id="backHome2">üè† Accueil</button>
      </div>
    </section>
  </main>

  <footer>
    <div>Arcathlon - √âquipe EPS Lyc√©e Vauban - LUXEMBOURG - JB</div>
  </footer>

  <!-- QRCode lib (tol√®re l'√©chec CDN) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
          onerror="window.QRCode=undefined"></script>

  <script>
  'use strict';

  /* ========= R√©glages prof ========= */
  const PROF_CODE = '57';

  // === Conseils / Observation ===
  const ADVICE_PER_SHOT = {
    10: [
      "Parfait ! Garde la routine (posture ‚Üí ancrage ‚Üí vis√©e ‚Üí souffle ‚Üí l√¢cher).",
      "Top tir ! Maintiens le suivi apr√®s le l√¢cher (arc bien tenu 1s)."
    ],
    9: [
      "Tr√®s bien. Garde le bras d‚Äôarc bien tendu jusqu‚Äô√† la fin.",
      "Super. Respire calmement et r√©p√®te la m√™me s√©quence."
    ],
    8: [
      "Bien. V√©rifie ton ancrage (index au coin des l√®vres) puis souffle avant de l√¢cher.",
      "Bien. Stabilise les √©paules et prends une seconde de plus pour viser."
    ],
    7: [
      "Correct. Aligne √©paules‚Äìcible, mains d√©tendues.",
      "Prends un peu plus de temps pour fixer la vis√©e."
    ],
    6: [
      "√Ä travailler. Monte l√©g√®rement le coude de corde et stabilise la vis√©e.",
      "Reste rel√¢ch√© dans la main de corde, vise plus longtemps."
    ],
    0: [
      "Reset mental : 5 grandes inspirations, yeux ferm√©s, puis posture ‚Üí ancrage ‚Üí vis√©e ‚Üí souffle ‚Üí l√¢cher.",
      "Remets-toi en place : check posture et ancrage avant de viser."
    ]
  };
  const VOLLEE_SEUIL_FAIBLE = 6.5; // /10
  const VOLLEE_SEUIL_HAUTE  = 8.5; // /10

  // Helpers & navigation
  function qs(sel){ return document.querySelector(sel); }
  const V = { cover: qs('#view-cover'), duo: qs('#view-duo'), course: qs('#view-course'), summary: qs('#view-summary') };
  function show(name){ Object.values(V).forEach(v=>v.classList.add('hidden')); V[name].classList.remove('hidden'); window.scrollTo(0,0); }
  qs('#btnStart').onclick = ()=> show('duo');

  // Modales
  function openModal(id){ document.getElementById(id).classList.remove('hidden'); }
  function closeModals(){ var list=document.querySelectorAll('.modal'); for(var i=0;i<list.length;i++){ list[i].classList.add('hidden'); } }
  document.getElementById('btnHelp').onclick = ()=> openModal('modalHelp');
  document.getElementById('btnSafety').onclick = ()=> openModal('modalSafety');
  document.getElementById('btnIndiceArc').onclick = ()=> openModal('modalIndice');
  var closers=document.querySelectorAll('.modal [data-close]'); for(var i=0;i<closers.length;i++){ closers[i].onclick = closeModals; }
  document.addEventListener('keydown',function(e){ if(e.key==='Escape') closeModals(); });

  // Quitter si en cours
  function confirmLeaveIfNeeded(){
    if(!session.finished && (session.laps>0 || session.shots.length>0 || elapsed>0)){
      return confirm('Quitter la course ? Les donn√©es non termin√©es pourraient √™tre perdues.');
    }
    return true;
  }
  qs('#goHome').onclick = ()=> { if(confirmLeaveIfNeeded()) show('cover'); };
  qs('#backToDuo').onclick = ()=> { if(confirmLeaveIfNeeded()) show('duo'); };

  // Validation
  function clean(s){ return (s||'').replace(/\s+/g,' ').trim(); }
  function hasValue(id){ return clean(document.getElementById(id).value).length>0; }
  function okNumber(v,min){ var n=+v; return Number.isFinite(n)&&n>=min; }
  function val(id){ return clean(document.getElementById(id).value); }

  function validate(){
    var fields=['p1_prenom','p1_nom','p1_classe','p1_sexe','p2_prenom','p2_nom','p2_classe','p2_sexe'];
    var ok=true;
    for(var i=0;i<fields.length;i++){
      var id=fields[i];
      var el=document.getElementById(id);
      var good=hasValue(id);
      el.style.borderColor = good?'#e5e7eb':'#ef4444';
      ok = ok && good;
    }
    var okDur=okNumber(val('duree_min'),1);
    var okTour=okNumber(val('tour_m'),10);
    var okTB=okNumber(val('tours_bloc'),1);
    var okFB=okNumber(val('fleches_bloc'),1);
    var ids=['duree_min','tour_m','tours_bloc','fleches_bloc'];
    for(var j=0;j<ids.length;j++){
      var id2=ids[j];
      var good2 = (id2==='duree_min'?okDur:(id2==='tour_m'?okTour:(id2==='tours_bloc'?okTB:okFB)));
      document.getElementById(id2).style.borderColor = good2 ? '#e5e7eb':'#ef4444';
    }
    ok = ok && okDur && okTour && okTB && okFB;
    document.getElementById('goCourse').disabled = !ok;
    return ok;
  }
  var valIds=['p1_prenom','p1_nom','p1_classe','p1_sexe','p2_prenom','p2_nom','p2_classe','p2_sexe','duree_min','tour_m','tours_bloc','fleches_bloc'];
  for(var vi=0;vi<valIds.length;vi++){
    var el=document.getElementById(valIds[vi]);
    el.addEventListener('input',validate); el.addEventListener('change',validate);
  }

  // Presets r√®gles
  function setRule(tb, fb){ document.getElementById('tours_bloc').value=tb; document.getElementById('fleches_bloc').value=fb; validate(); }
  document.getElementById('preset33').onclick = ()=> setRule(3,3);
  document.getElementById('preset11').onclick = ()=> setRule(1,1);
  document.getElementById('preset13').onclick = ()=> setRule(1,3);

  const session={
    p1:null, p2:null, tourM:0, dureeMin:0, rules:{tb:3,fb:3}, active:'p1',
    laps:0, frac:0, shots:[], results:{p1:null,p2:null}, finished:false,
    obs:{ on:false, mode:'none', tipCycle:{0:0,6:0,7:0,8:0,9:0,10:0} }
  };

  // Acc√®s course
  qs('#goCourse').onclick = ()=>{
    if(!validate()) { alert('Compl√©tez tous les champs (obligatoires) et v√©rifiez les nombres.'); return; }
    session.p1={ prenom:val('p1_prenom'), nom:val('p1_nom'), classe:val('p1_classe'), sexe:val('p1_sexe') };
    session.p2={ prenom:val('p2_prenom'), nom:val('p2_nom'), classe:val('p2_classe'), sexe:val('p2_sexe') };
    session.dureeMin=+val('duree_min'); session.tourM=+val('tour_m');
    session.rules.tb=+document.getElementById('tours_bloc').value;
    session.rules.fb=+document.getElementById('fleches_bloc').value;
    session.obs = {
      on: !!document.getElementById('obs_on').checked,
      mode: (document.getElementById('obs_mode').value || 'none'),
      tipCycle:{0:0,6:0,7:0,8:0,9:0,10:0}
    };
    session.active='p1'; resetRunnerState(); paintCourseHeader(); show('course');
  };

  // Course
  const clockEl=qs('#clock'), lapsEl=qs('#laps'), lapMetersEl=qs('#lapMeters'), targetEl=qs('#target');
  const shotsTable=qs('#shotsTable'), runnerTitle=qs('#runnerTitle'), courseMeta=qs('#courseMeta');
  const endCard=qs('#endCard'), distanceOut=qs('#distanceOut'), courseCard=qs('#courseCard');
  const toSummaryWrap=qs('#toSummaryWrap'); const liveDistanceEl=qs('#liveDistance');
  const allowedEl=qs('#allowed'), shotCountEl=qs('#shotCount'), remainEl=qs('#remain');
  const indiceArcEl=qs('#indiceArc');
  const c0El=qs('#c0'), c6El=qs('#c6'), c7El=qs('#c7'), c8El=qs('#c8'), c9El=qs('#c9'), c10El=qs('#c10');

  // Choix coureur
  qs('#pickP1').onclick=()=> switchRunner('p1');
  qs('#pickP2').onclick=()=> switchRunner('p2');

  // Tours
  qs('#lapPlus').onclick=()=>{ if(session.finished) return; session.laps++; renderLaps(); renderAllowances(); };
  qs('#lapMinus').onclick=()=>{ if(session.finished) return; session.laps=Math.max(0,session.laps-1); renderLaps(); renderAllowances(); };

  // Tir
  var btns = document.querySelectorAll('#scoreButtons [data-score]');
  for(var k=0;k<btns.length;k++){
    btns[k].onclick=function(){
      if(session.finished) return;
      var score=+this.getAttribute('data-score');
      var allowed = calcAllowedShots();
      if(session.shots.length>=allowed){ alert('Pas assez de tours pour tirer plus de fl√®ches.'); return; }
      addShot(score);
    };
  }

  // Chrono
  let t0=0, elapsed=0, timer=null, running=false;
  function start(){ if(session.finished||running) return; running=true; t0=Date.now()-elapsed; timer=setInterval(tick,100); qs('#btnStartCourse').disabled=true; qs('#btnPause').disabled=false; qs('#btnReset').disabled=false; }
  function pause(){ if(!running) return; running=false; clearInterval(timer); qs('#btnStartCourse').disabled=false; qs('#btnPause').disabled=true; }
  function reset(){ pause(); elapsed=0; clockEl.textContent='00:00.0'; qs('#btnReset').disabled=true; session.laps=0; session.shots=[]; session.frac=0; renderLaps(); renderAllowances(); renderShots(); renderAllSummaries(); hideEnd(); }
  function tick(){ elapsed=Date.now()-t0; var cs=Math.floor(elapsed/100); var m=Math.floor(cs/600), s=Math.floor((cs%600)/10), d=cs%10; clockEl.textContent=((m<10?'0':'')+m+':' + (s<10?'0':'')+s+'.'+d); if(m>=session.dureeMin){ pause(); showEnd(); } }
  qs('#btnStartCourse').onclick=start; qs('#btnPause').onclick=pause; qs('#btnReset').onclick=reset;

  // Fin (overlay)
  const endOverlay = document.getElementById('endOverlay');
  const distanceOutOverlay = document.getElementById('distanceOutOverlay');
  function updateDistanceOutputOverlay(){
    const meters=Math.round((session.laps+(session.frac||0))*session.tourM);
    distanceOutOverlay.textContent = 'Distance: '+meters+' m ('+session.laps+' tours + '+(session.frac||0)+' tour)';
  }
  function showEnd(){
    endCard.classList.remove('hidden');
    session.frac = session.frac || 0;
    updateDistanceOutputOverlay(); updateDistanceOutput();
    courseCard.classList.add('lock');
    endOverlay.classList.add('show');
    if(navigator.vibrate) navigator.vibrate(150);
  }
  function hideEnd(){
    endCard.classList.add('hidden');
    endOverlay.classList.remove('show');
    courseCard.classList.remove('lock');
  }
  var fracBtns=document.querySelectorAll('[data-frac-overlay]');
  for(var fb=0; fb<fracBtns.length; fb++){
    fracBtns[fb].onclick=function(){ if(session.finished) return; session.frac=+this.getAttribute('data-frac-overlay'); updateDistanceOutputOverlay(); };
  }
  document.getElementById('finishRunnerOverlay').onclick=()=> finalizeRunner();

  // Overlay bilan pr√™t
  const summaryOverlay = document.getElementById('summaryOverlay');
  function showSummaryOverlay(){ if(summaryOverlay){ summaryOverlay.classList.add('show'); if(navigator.vibrate) navigator.vibrate(120); } }
  function hideSummaryOverlay(){ if(summaryOverlay){ summaryOverlay.classList.remove('show'); } }
  const overlayGoBtn = document.getElementById('overlayGoSummary');
  if(overlayGoBtn) overlayGoBtn.onclick = ()=>{ hideSummaryOverlay(); var goBtn = document.getElementById('goSummary'); if (goBtn) goBtn.click(); };
  const overlayCloseBtn = document.getElementById('overlayCloseSummary');
  if(overlayCloseBtn) overlayCloseBtn.onclick = ()=> hideSummaryOverlay();

  // Panneau bas
  var endCardBtns=endCard.querySelectorAll('[data-frac]');
  for(var eb=0;eb<endCardBtns.length;eb++){
    endCardBtns[eb].onclick=function(){ if(session.finished) return; session.frac=+this.getAttribute('data-frac'); updateDistanceOutput(); updateDistanceOutputOverlay(); };
  }
  qs('#finishRunner').onclick=()=> { showEnd(); };

  function updateDistanceOutput(){
    const meters=Math.round((session.laps+(session.frac||0))*session.tourM);
    distanceOut.textContent='Distance: '+meters+' m ('+session.laps+' tours + '+(session.frac||0)+' tour)';
  }
  function renderLaps(){
    lapsEl.textContent=session.laps;
    liveDistanceEl.textContent = Math.round((session.laps+(session.frac||0))*session.tourM);
    targetEl.textContent=session.dureeMin;
    lapMetersEl.textContent=session.tourM;
  }

  // Shots / r√®gles
  function calcAllowedShots(){
    const tb=session.rules.tb, fb=session.rules.fb;
    const blocs = Math.floor(session.laps / tb);
    return blocs * fb;
  }
  function renderAllowances(){
    const allowed=calcAllowedShots();
    allowedEl.textContent = allowed;
    shotCountEl.textContent = session.shots.length;
    remainEl.textContent = Math.max(0, allowed - session.shots.length);
  }

  function addShot(score){
    const n=session.shots.length+1;
    session.shots.push({n: n, score: score});
    renderShots();
    renderAllowances();
    renderAllSummaries();
    // Conseils
    maybeCoachPerShot(score);
    if(session.rules && session.rules.fb>0 && (session.shots.length % session.rules.fb === 0)){
      maybeCoachEndOfVolley();
    }
  }
  function renderShots(){
    shotsTable.innerHTML='';
    var arr = session.shots.slice().reverse();
    for(var i=0;i<arr.length;i++){
      const s=arr[i];
      const tr=document.createElement('tr');
      tr.innerHTML='<td>'+s.n+'</td><td>'+s.score+'</td><td><button class="b-red">Retirer</button></td>';
      (function(sN){
        tr.querySelector('button').onclick=function(){
          if(session.finished) return;
          session.shots=session.shots.filter(function(x){ return x.n!==sN; }).map(function(x,i){ return {n:i+1,score:x.score}; });
          renderShots(); renderAllowances(); renderAllSummaries();
        };
      })(s.n);
      shotsTable.appendChild(tr);
    }
  }
  function scoreCounts(){
    var c={0:0,6:0,7:0,8:0,9:0,10:0};
    for(var i=0;i<session.shots.length;i++){
      var sc=session.shots[i].score;
      if(c.hasOwnProperty(sc)) c[sc]++;
    }
    return c;
  }
  function sumScores(){
    var s=0;
    for(var i=0;i<session.shots.length;i++){
      var sh=session.shots[i];
      s += (sh && sh.score) ? sh.score : 0;
    }
    return s;
  }
  function computeIndiceArc(){
    const T=session.shots.length;
    if(!T) return 0;
    const avg = sumScores()/T; // 0..10
    return +(avg*10).toFixed(2); // %
  }
  function renderAllSummaries(){
    const c=scoreCounts();
    c0El.textContent=c[0];
    c6El.textContent=c[6]; c7El.textContent=c[7]; c8El.textContent=c[8]; c9El.textContent=c[9]; c10El.textContent=c[10];
    indiceArcEl.textContent = computeIndiceArc();
  }

  // Conseils
  function getAdviceForScore(score){
    var arr = ADVICE_PER_SHOT[score] || [];
    if (!arr.length) return "";
    var i = session.obs.tipCycle[score] || 0;
    var txt = arr[i % arr.length];
    session.obs.tipCycle[score] = (i+1) % arr.length;
    return txt;
  }
  function showCoachTip(text, flavor){
    var box = document.getElementById('coachBox');
    if(!box || !text) return;
    box.classList.remove('hidden');
    var div = document.createElement('div');
    div.className = 'coachtip ' + (flavor || 'ok');
    div.innerHTML = '<span>üëÄ</span><div>'+ text +'</div>';
    box.prepend(div);
    setTimeout(function(){
      if(div && div.parentNode) div.parentNode.removeChild(div);
      if(box && box.children.length===0) box.classList.add('hidden');
    }, 5000);
  }
  function maybeCoachPerShot(score){
    if(!session.obs.on) return;
    var txt = getAdviceForScore(score);
    if(!txt) return;
    var flavor = (score>=9)?'good' : (score>=7)?'ok' : (score>=6)?'warn' : 'alert';
    showCoachTip(txt, flavor);
  }
  function maybeCoachEndOfVolley(){
    if(!session.obs.on) return;
    var fb = session.rules.fb, n = session.shots.length;
    if(fb<=0 || n<fb) return;
    var recent = session.shots.slice(Math.max(0, n - fb));
    var sum=0; for(var i=0;i<recent.length;i++){ sum += (recent[i] && recent[i].score) ? recent[i].score : 0; }
    var avg = sum / fb; // /10
    var msg = "Vol√©e termin√©e. Continue ainsi."; var flavor='ok';
    if(session.obs.mode==='remediation'){
      if(avg < VOLLEE_SEUIL_FAIBLE){ msg = "Vol√©e faible : tu peux AVANCER d'une zone pour t'aider."; flavor='alert'; }
      else if(avg >= VOLLEE_SEUIL_HAUTE){ msg = "Vol√©e solide : reste sur cette zone et vise la r√©gularit√©."; flavor='good'; }
      else { msg = "Vol√©e correcte : garde la routine, cherche la stabilit√©."; flavor='ok'; }
    }else if(session.obs.mode==='challenge'){
      if(avg >= VOLLEE_SEUIL_HAUTE){ msg = "Tr√®s bonne vol√©e : tu peux RECULER d'une zone pour te challenger."; flavor='good'; }
      else if(avg < VOLLEE_SEUIL_FAIBLE){ msg = "Vol√©e fragile : reste sur cette zone et travaille la s√©quence."; flavor='warn'; }
      else { msg = "Vol√©e correcte : reste sur la zone actuelle."; flavor='ok'; }
    }
    showCoachTip("‚Üª " + msg + " (moyenne vol√©e " + avg.toFixed(1) + "/10)", flavor);
  }

  function switchRunner(which){
    if(session.finished) return;
    saveTemp();
    session.active=which;
    reset();
    resetRunnerState();
    paintCourseHeader();
    loadTemp();
  }
  function resetRunnerState(){ session.laps=0; session.shots=[]; session.frac=0; renderLaps(); renderAllowances(); renderShots(); renderAllSummaries(); hideEnd(); }
  function paintCourseHeader(){
    const R=session[session.active];
    runnerTitle.textContent='Coureur ‚Äî '+R.prenom+' '+R.nom;
    courseMeta.textContent=R.classe+' ‚Ä¢ '+R.sexe;
    lapMetersEl.textContent=session.tourM;
    targetEl.textContent=session.dureeMin;
  }

  const temp={ p1:{laps:0,frac:0,shots:[]}, p2:{laps:0,frac:0,shots:[]} };
  function saveTemp(){ temp[session.active]={ laps:session.laps, frac:session.frac, shots:JSON.parse(JSON.stringify(session.shots)) }; }
  function loadTemp(){ const t=temp[session.active]; session.laps=t.laps; session.frac=t.frac; session.shots=JSON.parse(JSON.stringify(t.shots)); renderLaps(); renderAllowances(); renderShots(); renderAllSummaries(); hideEnd(); }

  function finalizeRunner(){
    const R=session[session.active];
    const meters=Math.round((session.laps+(session.frac||0))*session.tourM);
    const c=scoreCounts();
    const indice=computeIndiceArc();

    session.results[session.active]={ prenom:R.prenom, nom:R.nom, classe:R.classe, sexe:R.sexe,
      distance:meters,
      nb0:c[0], nb6:c[6], nb7:c[7], nb8:c[8], nb9:c[9], nb10:c[10],
      indice_arc: indice
    };

    hideEnd();
    courseCard.classList.add('lock');
    setTimeout(()=> courseCard.classList.remove('lock'), 250);

    const other=session.active==='p1'?'p2':'p1';
    if(!session.results[other]){
      alert('Coureur termin√©. Passez au second coureur.');
      switchRunner(other);
      return;
    }
    session.finished=true;
    document.getElementById('pickP1').disabled=true;
    document.getElementById('pickP2').disabled=true;
    toSummaryWrap.classList.remove('hidden');
    showSummaryOverlay();
  }

  // Bilan / QR + MODE PROF
  const backToCourseBtn=qs('#backToCourse'); const backHome2Btn=qs('#backHome2'); const goSummaryBtn=qs('#goSummary');
  let summaryData = []; let profMode = false;

  function buildQrData(dataRows){
    return dataRows.map(function(d){
      return {
        nom: d.nom, prenom: d.prenom, classe: d.classe, sexe: d.sexe,
        distance: d.distance, nb0: d.nb0, nb6: d.nb6, nb7: d.nb7, nb8: d.nb8, nb9: d.nb9, nb10: d.nb10, indice_arc: d.indice_arc
      };
    });
  }
  function buildQR(payload){
    const qrBox=document.getElementById('qr');
    qrBox.innerHTML='';
    try{ if(window.QRCode){ new QRCode(qrBox,{ text:payload, width:256, height:256, correctLevel:QRCode.CorrectLevel.M }); } }
    catch(e){ console.warn('QR non g√©n√©r√©:', e); }
  }

  function toCSV(data) {
    const headers = ['nom','prenom','classe','sexe','distance','nb0','nb6','nb7','nb8','nb9','nb10','indice_arc'];
    const esc = function(v){
      const s = (v==null ? '' : String(v));
      if (/[;\"\n]/.test(s)) return '"'+s.replace(/\"/g,'""')+'"';
      return s;
    };
    const lines = [
      headers.join(';')
    ];
    for(var i=0;i<data.length;i++){
      const d=data[i];
      const row=[]; for(var h=0;h<headers.length;h++){ row.push(esc(d[headers[h]])); }
      lines.push(row.join(';'));
    }
    return lines.join('\n');
  }

  function renderSummary(){
    const rows = summaryData.map(function(d,i){
      return (
      '<tr data-index="'+i+'">'+
        '<td data-field="nom" '+(profMode?'contenteditable="true"':'')+'>'+(d.nom||'')+'</td>'+
        '<td data-field="prenom" '+(profMode?'contenteditable="true"':'')+'>'+(d.prenom||'')+'</td>'+
        '<td data-field="classe" '+(profMode?'contenteditable="true"':'')+'>'+(d.classe||'')+'</td>'+
        '<td data-field="sexe" '+(profMode?'contenteditable="true"':'')+'>'+(d.sexe||'')+'</td>'+
        '<td data-field="distance" '+(profMode?'contenteditable="true"':'')+'>'+(d.distance||0)+'</td>'+
        '<td data-field="nb0" '+(profMode?'contenteditable="true"':'')+'>'+(d.nb0||0)+'</td>'+
        '<td data-field="nb6" '+(profMode?'contenteditable="true"':'')+'>'+(d.nb6||0)+'</td>'+
        '<td data-field="nb7" '+(profMode?'contenteditable="true"':'')+'>'+(d.nb7||0)+'</td>'+
        '<td data-field="nb8" '+(profMode?'contenteditable="true"':'')+'>'+(d.nb8||0)+'</td>'+
        '<td data-field="nb9" '+(profMode?'contenteditable="true"':'')+'>'+(d.nb9||0)+'</td>'+
        '<td data-field="nb10" '+(profMode?'contenteditable="true"':'')+'>'+(d.nb10||0)+'</td>'+
        '<td>'+(d.indice_arc||0)+'</td>'+
      '</tr>'
      );
    }).join('');
    document.getElementById('resume').innerHTML =
      '<table id="summaryTable" '+(profMode?'class="prof-on"':'')+'>'+
        '<thead>'+
          '<tr>'+
            '<th>Nom</th><th>Pr√©nom</th><th>Classe</th><th>Sexe</th>'+
            '<th>Distance (m)</th>'+
            '<th>Nb 0</th><th>Nb 6</th><th>Nb 7</th><th>Nb 8</th><th>Nb 9</th><th>Nb 10</th>'+
            '<th>Indice arc (%)</th>'+
          '</tr>'+
        '</thead>'+
        '<tbody id="resumeBody">'+rows+'</tbody>'+
      '</table>';

    const payloadQR = JSON.stringify(buildQrData(summaryData));
    buildQR(payloadQR);

    const exportBtn = document.getElementById('exportCsv');
    exportBtn.onclick = function(){
      const csv = toCSV(summaryData);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const fileDate = new Date().toISOString().slice(0,10);
      a.href = url; a.download = 'Arcathlon_'+fileDate+'.csv';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    const profHint = document.getElementById('profHint');
    const act = document.getElementById('activateProf');
    const deact = document.getElementById('deactivateProf');
    const apply = document.getElementById('applyEdits');
    act.disabled = profMode; deact.disabled = !profMode; apply.disabled = !profMode;
    profHint.textContent = profMode
      ? 'Mode Prof activ√© : corrigez (distance, nb0..nb10) puis ‚ÄúMettre √† jour QR/CSV‚Äù. Indice recalcul√©.'
      : 'Saisir votre code Prof pour corriger une valeur.';
  }

  function parseEditsFromTable(){
    const tbody = document.getElementById('resumeBody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    return rows.map(function(tr){
      function txt(field){ var el=tr.querySelector('[data-field="'+field+'"]'); return (el?el.textContent:'').trim(); }
      function int(field, def){ var v=parseInt((txt(field)||'').replace(',', '.'),10); return Number.isFinite(v)? Math.max(0,v) : (def||0); }

      const nb0=int('nb0'), nb6=int('nb6'), nb7=int('nb7'), nb8=int('nb8'), nb9=int('nb9'), nb10=int('nb10');
      const totalShots = nb0+nb6+nb7+nb8+nb9+nb10;
      const totalPoints = nb6*6 + nb7*7 + nb8*8 + nb9*9 + nb10*10;
      const indice = totalShots>0 ? +(((totalPoints/totalShots)/10*100).toFixed(2)) : 0;

      return {
        nom: txt('nom'), prenom: txt('prenom'), classe: txt('classe'),
        sexe: (txt('sexe')||'F').toUpperCase()==='M'?'M':'F',
        distance: int('distance'),
        nb0, nb6, nb7, nb8, nb9, nb10,
        indice_arc: indice
      };
    });
  }

  document.getElementById('activateProf').onclick = function(){
    const code = (document.getElementById('profCode').value||'').trim();
    if(code === PROF_CODE){ profMode = true; renderSummary(); } else { alert('Code incorrect.'); }
  };
  document.getElementById('deactivateProf').onclick = function(){ profMode = false; renderSummary(); };
  document.getElementById('applyEdits').onclick = function(){
    if(!profMode) return;
    const updated = parseEditsFromTable();
    summaryData = updated;
    renderSummary();
    alert('Bilan mis √† jour. QR et CSV r√©g√©n√©r√©s.');
  };

  // Aller au bilan
  document.getElementById('goSummary').onclick=function(){
    const out=[];
    if(session.results.p1) out.push(JSON.parse(JSON.stringify(session.results.p1)));
    if(session.results.p2) out.push(JSON.parse(JSON.stringify(session.results.p2)));
    summaryData = out;
    show('summary');
    profMode = false;
    renderSummary();
  };

  qs('#backToCourse').onclick=function(){ show('course'); };
  qs('#backHome2').onclick=function(){ if(confirmLeaveIfNeeded()) show('cover'); };

  // Init
  validate();
  try{ console.assert(!!V.cover && !!V.duo && !!V.course && !!V.summary, 'vues ok'); }catch(_){ }
  </script>
</body>
</html>
